# SIP Client

Автоматический SIP-абонент для подключения к SIP серверу и обмена RTP потоками.

## Возможности

- Автоматическая регистрация на SIP сервере
- Поддержка Digest аутентификации
- Автоматический ответ на входящие звонки
- Передача аудио семплов (настраиваемая частота)
- Обработка RTP потоков
- Поддержка DTMF тонов
- Гибкая конфигурация через переменные окружения

## Установка

```bash
npm install
```

## Быстрый запуск

### Базовый запуск
```bash
./start.sh
```

### Запуск с кастомными параметрами
```bash
./start-custom.sh [SIP_HOST] [SIP_PORT] [USERNAME] [PASSWORD] [DOMAIN] [FREQUENCY]
```

Примеры:
```bash
# Подключение к удаленному серверу с паролем
./start-custom.sh 192.168.1.100 5060 my_client mypassword sip.example.com 880

# Подключение с другим именем пользователя и паролем
./start-custom.sh 127.0.0.1 5060 test_user testpass localhost 660

# Только изменить частоту тона
./start-custom.sh 127.0.0.1 5060 sip_client "" localhost 1000
```

## Конфигурация

### Переменные окружения

Создайте файл `.env` на основе `env.example`:

```bash
cp env.example .env
```

#### Основные настройки:

**SIP Configuration:**
- `SIP_LOCAL_PORT` - Локальный порт для SIP (по умолчанию: 5060)
- `SIP_REMOTE_HOST` - Адрес SIP сервера (по умолчанию: 127.0.0.1)
- `SIP_REMOTE_PORT` - Порт SIP сервера (по умолчанию: 5060)
- `SIP_USERNAME` - Имя пользователя (по умолчанию: sip_client)
- `SIP_PASSWORD` - Пароль для аутентификации (по умолчанию: пустой)
- `SIP_DOMAIN` - Домен (по умолчанию: localhost)
- `SIP_AUTH_REQUIRED` - Требуется ли аутентификация (true/false)

**RTP Configuration:**
- `RTP_LOCAL_PORT` - Локальный порт для RTP (по умолчанию: 10000)
- `RTP_REMOTE_HOST` - Адрес RTP сервера (по умолчанию: 127.0.0.1)
- `RTP_REMOTE_PORT` - Порт RTP сервера (по умолчанию: 10000)

**Audio Configuration:**
- `AUDIO_FREQUENCY` - Частота генерируемого тона в Гц (по умолчанию: 440)
- `AUDIO_AMPLITUDE` - Амплитуда тона (по умолчанию: 0.3)
- `AUDIO_SAMPLE_RATE` - Частота дискретизации (по умолчанию: 8000)

**Logging Configuration:**
- `LOG_LEVEL` - Уровень логирования (error, warn, info, debug)
- `LOG_SIP` - Включить логи SIP сообщений (true/false)
- `LOG_RTP` - Включить логи RTP пакетов (true/false)
- `LOG_AUDIO` - Включить логи аудио данных (true/false)

### Пример .env файла:

```env
# SIP Configuration
SIP_LOCAL_PORT=5060
SIP_REMOTE_HOST=192.168.1.100
SIP_REMOTE_PORT=5060
SIP_USERNAME=my_sip_client
SIP_PASSWORD=my_secret_password
SIP_DOMAIN=sip.example.com
SIP_AUTH_REQUIRED=true

# Audio Configuration
AUDIO_FREQUENCY=880
AUDIO_AMPLITUDE=0.5

# Logging
LOG_LEVEL=debug
LOG_SIP=true
LOG_RTP=false
```

## Аутентификация

Клиент поддерживает Digest аутентификацию (RFC 2617):

1. **Автоматическое определение**: Клиент автоматически определяет необходимость аутентификации по ответу 401 Unauthorized
2. **Поддерживаемые алгоритмы**: MD5 (по умолчанию)
3. **QOP**: Поддерживается qop="auth"
4. **Безопасность**: Пароль передается в виде MD5 хеша

### Настройка аутентификации:

```env
# Включить аутентификацию
SIP_AUTH_REQUIRED=true
SIP_USERNAME=your_username
SIP_PASSWORD=your_password
```

## Запуск

### Стандартный запуск
```bash
npm start
```

### Режим разработки
```bash
npm run dev
```

### Через скрипты
```bash
# Базовый запуск с дефолтными настройками
./start.sh

# Запуск с кастомными параметрами
./start-custom.sh 192.168.1.100 5060 my_client mypassword sip.example.com 880
```

## Как работает

1. **Запуск**: Клиент автоматически запускается и регистрируется на SIP сервере
2. **Аутентификация**: При необходимости выполняет Digest аутентификацию
3. **Ожидание**: Клиент ждет входящие звонки
4. **Входящий звонок**: При получении INVITE автоматически отвечает 200 OK
5. **Аудио обмен**: Начинает передачу аудио семплов с настроенной частотой каждые 20мс
6. **Завершение**: При получении BYE завершает звонок

## Требования

- Node.js 16+
- Доступ к SIP серверу
- Открытые порты для SIP (5060) и RTP (10000)
- Учетные данные для аутентификации (если требуется)

## Структура проекта

```
sip-client/
├── src/
│   ├── index.js      # Основной SIP клиент
│   └── rtp-handler.js # Обработчик RTP потоков
├── config.js         # Конфигурация
├── env.example       # Пример переменных окружения
├── start.sh          # Скрипт базового запуска
├── start-custom.sh   # Скрипт запуска с параметрами
├── package.json      # Зависимости
└── README.md         # Документация
```

## Логи

Клиент выводит подробные логи с временными метками:
- Статус регистрации
- Процесс аутентификации
- Входящие звонки
- Начало/завершение аудио обмена
- Полученные RTP пакеты (если включено)

## Лицензия

ISC 